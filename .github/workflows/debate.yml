name: AI Debate Schedule

on:
  schedule:
    # Tijden in UTC - Amsterdam is UTC+1 (winter) / UTC+2 (zomer)
    # Winter: trek 1 uur af | Zomer: trek 2 uur af
    
    # Zondag 22:00 Amsterdam = 21:00 UTC winter
    - cron: '0 21 * * 0'
    
    # Ma-Vr 08:00 Amsterdam = 07:00 UTC winter
    - cron: '0 7 * * 1-5'
    
    # Ma-Vr 12:00 Amsterdam = 11:00 UTC winter
    - cron: '0 11 * * 1-5'
    
    # Ma-Vr 18:00 Amsterdam = 17:00 UTC winter
    - cron: '0 17 * * 1-5'
    
    # Ma-Vr 22:00 Amsterdam = 21:00 UTC winter
    - cron: '0 21 * * 1-5'
    
    # Zaterdag 22:00 Amsterdam = 21:00 UTC winter
    - cron: '0 21 * * 6'

  # Handmatig triggeren voor testen
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Forceer uitvoering ongeacht tijd'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-debate-posts:
    runs-on: ubuntu-latest
    
    # Permissions voor GitHub Pages
    permissions:
      contents: write
      pages: write
      id-token: write
    
    # Environment voor GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    # Voorkom dubbele runs
    concurrency:
      group: debate-engine
      cancel-in-progress: false
    
    steps:
      # 1. Code ophalen
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
      
      # 2. Node.js setup
      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # 3. Dependencies installeren (indien nodig)
      - name: ğŸ“¦ Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f package.json ]; then
            npm install
          fi
      
      # 4. Debate engine uitvoeren
      - name: ğŸ¤– Run Debate Engine
        run: node debate-engine.js
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TZ: Europe/Amsterdam
      
      # 5. Wijzigingen committen naar main branch
      - name: ğŸ“ Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "AI Debate Bot"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ Geen wijzigingen om te committen"
          else
            TIMESTAMP=$(TZ=Europe/Amsterdam date '+%Y-%m-%d %H:%M')
            git commit -m "ğŸ¤– Debate update: ${TIMESTAMP}"
            
            # Pull en push met rebase
            git pull --rebase origin main || true
            git push
            echo "âœ… Wijzigingen gepushed"
          fi
      
      # 6. Deploy naar GitHub Pages
      - name: ğŸš€ Setup Pages
        uses: actions/configure-pages@v4
      
      - name: ğŸ“¦ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'
      
      - name: ğŸŒ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
